<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caf√© San Juan | Matem√°ticas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuraci√≥n Tailwind para modo oscuro -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        amber: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    },
                    animation: {
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'zoom-in': 'zoomIn 0.3s ease-out forwards',
                        'bounce-slow': 'bounce 2s infinite',
                        'confetti': 'confetti 1s ease-out forwards',
                    },
                    keyframes: {
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '25%': { transform: 'translateX(-5px)' },
                            '75%': { transform: 'translateX(5px)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        zoomIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- MathJax para fracciones verticales -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- React & ReactDOM (Versiones de Producci√≥n Estables) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Estilos base */
        body, html { height: 100%; margin: 0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 20px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #4b5563; }
        
        /* Animaci√≥n de confeti simple con CSS */
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd300;
            top: 0;
            opacity: 0;
        }
        .celebration-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURACI√ìN DEL FORMULARIO DE GOOGLE (EDITAR AQU√ç) ---
        
        const GOOGLE_FORM_CONFIG = {
            // Cambia esto a true una vez hayas puesto tus datos reales abajo
            enabled: false, 
            
            // URL del formulario (ejemplo: https://docs.google.com/forms/d/e/.../formResponse)
            formUrl: "https://docs.google.com/forms/d/e/TU_ID_DE_FORMULARIO_AQUI/formResponse", 
            
            // IDs de los campos (entry.XXXXXX)
            fields: {
                name: "entry.123456789",   // Campo para Nombre
                role: "entry.234567890",   // Campo para Rol
                group: "entry.345678901",  // Campo para Grado/Grupo
                score: "entry.456789012",  // Campo para Puntaje (ej. 8/10)
                time: "entry.567890123"    // Campo para Tiempo (ej. 02:30)
            }
        };

        // --- ICON SYSTEM ---
        const Icon = ({ path, className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Coffee: (props) => <Icon {...props} path={<><path d="M18 8h1a4 4 0 0 1 0 8h-1" /><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z" /><line x1="6" y1="1" x2="6" y2="4" /><line x1="10" y1="1" x2="10" y2="4" /><line x1="14" y1="1" x2="14" y2="4" /></>} />,
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>} />,
            Award: (props) => <Icon {...props} path={<><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></>} />,
            CheckCircle: (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>} />,
            XCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" /><line x1="9" y1="9" x2="15" y2="15" /></>} />,
            Menu: (props) => <Icon {...props} path={<><line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" /></>} />,
            X: (props) => <Icon {...props} path={<><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>} />,
            ChevronRight: (props) => <Icon {...props} path={<><polyline points="9 18 15 12 9 6" /></>} />,
            User: (props) => <Icon {...props} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>} />,
            Moon: (props) => <Icon {...props} path={<><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></>} />,
            Sun: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></>} />,
            Leaf: (props) => <Icon {...props} path={<><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 6.5-5.5 12.5-1.4 1.1-2.9 2.5-2.5 5.5Z" /><path d="m2 2 20 20" /></>} />,
            BarChart: (props) => <Icon {...props} path={<><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></>} />,
            RefreshCw: (props) => <Icon {...props} path={<><polyline points="23 4 23 10 17 10" /><polyline points="1 20 1 14 7 14" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></>} />,
            Home: (props) => <Icon {...props} path={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></>} />,
            ArrowRight: (props) => <Icon {...props} path={<><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></>} />,
            Star: (props) => <Icon {...props} path={<><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></>} />,
            Send: (props) => <Icon {...props} path={<><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></>} />,
        };

        const { 
            Coffee, BookOpen, Clock, Award, CheckCircle, XCircle, Menu, X, 
            ChevronRight, User, Moon, Sun, Leaf, BarChart, RefreshCw, Home, ArrowRight, Star, Send
        } = Icons;

        // --- DATOS Y CONTENIDO ---

        const LEVELS_DATA = [
            {
                id: 'level0',
                title: 'Nivel 0: Conceptual',
                icon: <BookOpen className="w-5 h-5" />,
                description: 'Recursos multimedia y bases te√≥ricas.',
                content: (
                <div className="space-y-6">
                    <div className="bg-amber-50 dark:bg-amber-900/20 p-6 rounded-xl border-l-4 border-amber-600">
                        <h3 className="text-xl font-bold text-amber-800 dark:text-amber-300 mb-2">Introducci√≥n</h3>
                        <p className="text-gray-700 dark:text-gray-300 mb-4">
                            Antes de ir al campo, necesitamos entender los fundamentos. En el Proyecto Pedag√≥gico Productivo 
                            <strong> Caf√© San Juan</strong>, las matem√°ticas son una herramienta diaria.
                        </p>
                        <div className="p-3 bg-amber-100 dark:bg-amber-800/30 rounded border border-amber-200 dark:border-amber-700/50 text-sm text-amber-900 dark:text-amber-100">
                            <strong>Idea clave de este m√≥dulo:</strong> En esta app las fracciones aparecen siempre dentro de una historia de caf√©: 
                            recolecci√≥n, transformaci√≥n y preparaci√≥n de la bebida. La meta es pasar de ver fracciones como algo "raro" 
                            a verlas como una herramienta para tomar decisiones.
                        </div>
                    </div>
                    
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div className="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-amber-100 dark:border-amber-900/50">
                            <h4 className="font-bold flex items-center gap-2 text-amber-700 dark:text-amber-400">
                            <span className="text-2xl">üé•</span> Video Explicativo
                            </h4>
                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">Introducci√≥n visual a los conceptos que usaremos en el campo.</p>
                            <a href="https://www.youtube.com/watch?v=yU_Jg30TnJo" target="_blank" rel="noopener noreferrer" className="mt-3 inline-block text-sm font-semibold text-amber-600 hover:underline">
                            Ver en YouTube ‚Üó
                            </a>
                        </div>
                        <div className="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-amber-100 dark:border-amber-900/50">
                            <h4 className="font-bold flex items-center gap-2 text-amber-700 dark:text-amber-400">
                            <span className="text-2xl">üéß</span> Audio Gu√≠a
                            </h4>
                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">Escucha la explicaci√≥n detallada sobre el uso de fracciones.</p>
                            <a href="https://drive.google.com/file/d/1OWchN7zXxV5SmNJtRpa0sPkRJJdDt8fh/view?usp=sharing" target="_blank" rel="noopener noreferrer" className="mt-3 inline-block text-sm font-semibold text-amber-600 hover:underline">
                            Escuchar Audio ‚Üó
                            </a>
                        </div>
                        <div className="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-amber-100 dark:border-amber-900/50">
                            <h4 className="font-bold flex items-center gap-2 text-amber-700 dark:text-amber-400">
                            <span className="text-2xl">üìä</span> Diapositivas
                            </h4>
                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">Material gr√°fico de soporte para repasar en cualquier momento.</p>
                            <a href="https://drive.google.com/file/d/1V-MzbwVlosZP0xpzb4IxO2AVi4CLkL6Q/view?usp=sharing" target="_blank" rel="noopener noreferrer" className="mt-3 inline-block text-sm font-semibold text-amber-600 hover:underline">
                            Abrir PDF ‚Üó
                            </a>
                        </div>
                    </div>
                </div>
                )
            },
            {
                id: 'level1',
                title: 'Nivel 1: Recolecci√≥n',
                icon: <Leaf className="w-5 h-5" />,
                description: 'Fracciones impropias y unidades de medida.',
                content: (
                <div className="space-y-6">
                    <img 
                        src="https://res.cloudinary.com/dgqpeth4f/image/upload/v1764970328/nivel_1_app_fracciones.png_jumskr.jpg" 
                        alt="Ilustraci√≥n Nivel 1" 
                        className="w-full rounded-xl shadow-md mb-4"
                    />
                    <p className="text-lg text-gray-700 dark:text-gray-300 leading-relaxed">
                    Imaginemos que una <strong>unidad</strong> es una canasta llena de caf√© cereza. 
                    Si se parte la canasta en 2 partes iguales, cada parte es <strong>{'\\(\\frac{1}{2}\\)'}</strong>.
                    </p>

                    <div className="bg-white dark:bg-gray-800 p-5 rounded-lg border border-amber-200 dark:border-amber-800 shadow-sm">
                        <p className="text-gray-700 dark:text-gray-300 mb-3">
                            Un n√∫mero como <strong>{'\\(1\\frac{1}{2}\\)'}</strong> se llama <strong>n√∫mero mixto</strong>. Se lee como "una unidad y un medio" o simplemente "uno y medio".
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300 ml-2">
                            <li><strong>El n√∫mero entero (1):</strong> Representa una cantidad completa. En la imagen, la primera canasta es 1 UNIDAD, es decir, una canasta completa de caf√© cereza.</li>
                            <li><strong>La fracci√≥n ({'\\(\\frac{1}{2}\\)'}):</strong> Representa una parte de una segunda unidad. La segunda canasta en la imagen est√° dividida en dos partes iguales, y una de esas partes es {'\\(\\frac{1}{2}\\)'}, o media canasta.</li>
                            <li><strong>Significado Conjunto:</strong> Por lo tanto, {'\\(1\\frac{1}{2}\\)'} significa que tienes una canasta completa m√°s la mitad de otra canasta.</li>
                        </ul>
                    </div>
                    
                    <div className="bg-green-50 dark:bg-green-900/20 p-5 rounded-lg border border-green-200 dark:border-green-800">
                        <h4 className="font-bold text-green-800 dark:text-green-300 mb-2">Fracciones Impropias (Mayores que 1)</h4>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                            <li>Una canasta y media = <strong>{'\\(1\\frac{1}{2}\\)'}</strong> = <strong>{'\\(\\frac{3}{2}\\)'}</strong> (tres mitades).</li>
                            <li>Dos canastas y media = <strong>{'\\(2\\frac{1}{2}\\)'}</strong> = <strong>{'\\(\\frac{5}{2}\\)'}</strong> (cinco mitades).</li>
                            <li>Una canasta y cuarto = <strong>{'\\(1\\frac{1}{4}\\)'}</strong> = <strong>{'\\(\\frac{5}{4}\\)'}</strong> (cinco cuartos).</li>
                        </ul>
                    </div>

                    <img 
                        src="https://res.cloudinary.com/dgqpeth4f/image/upload/v1764983518/Denumeromixtoafraccionimpropia_nivel1.png_kti2ip.jpg" 
                        alt="Conversi√≥n de n√∫mero mixto a fracci√≥n impropia" 
                        className="w-full rounded-xl shadow-md mb-4"
                    />

                    <div className="bg-blue-50 dark:bg-blue-900/20 p-5 rounded-lg border border-blue-200 dark:border-blue-800 mb-4">
                        <h4 className="font-bold text-blue-800 dark:text-blue-300 mb-2">Conversi√≥n: N√∫mero Mixto a Fracci√≥n Impropia</h4>
                        <p className="text-gray-700 dark:text-gray-300 mb-2">
                            Una <strong>fracci√≥n impropia</strong> es aquella en la que el numerador (arriba) es mayor o igual que el denominador (abajo).
                            Para convertir un n√∫mero mixto a una fracci√≥n impropia, se sigue este proceso:
                        </p>
                        <ul className="list-decimal list-inside space-y-2 text-gray-700 dark:text-gray-300 ml-2 mb-3">
                            <li><strong>Multiplicar</strong> el n√∫mero entero por el denominador: {'\\(1 \\times 2 = 2\\)'}. Esto te dice cu√°ntas mitades hay en la unidad completa.</li>
                            <li><strong>Sumar</strong> el numerador: Al resultado anterior, s√∫male el numerador de la fracci√≥n: {'\\(2 + 1 = 3\\)'}. Este es tu nuevo numerador.</li>
                            <li><strong>Mantener</strong> el denominador: El denominador sigue siendo el mismo ({'\\(2\\)'}), ya que seguimos hablando de "mitades".</li>
                        </ul>
                        <p className="font-bold text-center text-blue-900 dark:text-blue-200 mb-3 text-lg">Resultado: {'\\(1\\frac{1}{2} = \\frac{3}{2}\\)'}</p>
                        
                        <h5 className="font-bold text-blue-800 dark:text-blue-300 mt-4 mb-1">Explicaci√≥n Te√≥rica</h5>
                        <ul className="list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300 text-sm">
                            <li>Una fracci√≥n propia (ej. {'\\(\\frac{1}{2}\\)'}) siempre es menor que 1.</li>
                            <li>Una fracci√≥n donde numerador = denominador (ej. {'\\(\\frac{2}{2}\\)'}) es igual a 1.</li>
                            <li>Cuando el numerador es mayor (ej. {'\\(\\frac{3}{2}\\)'}), el valor es mayor que 1. En este caso, {'\\(3 > 2\\)'}, por lo tanto {'\\(\\frac{3}{2} > 1\\)'}.</li>
                        </ul>

                        <h5 className="font-bold text-blue-800 dark:text-blue-300 mt-4 mb-1">Relaci√≥n con el Ejercicio</h5>
                        <p className="text-gray-700 dark:text-gray-300 text-sm">
                            La conversi√≥n que acabamos de hacer ({'\\(1\\frac{1}{2} = \\frac{3}{2}\\)'}) demuestra perfectamente esta idea. 
                            Empezamos con un n√∫mero mixto ({'\\(1\\frac{1}{2}\\)'}) que claramente es mayor que 1, y lo convertimos a una fracci√≥n impropia ({'\\(\\frac{3}{2}\\)'}). 
                            El resultado es consistente: {'\\(\\frac{3}{2}\\)'} es una fracci√≥n impropia y su valor es mayor que 1, tal como dice la regla.
                        </p>
                    </div>

                    <div className="bg-amber-100 dark:bg-amber-900/40 p-4 rounded-lg border-l-4 border-amber-500 text-sm text-amber-900 dark:text-amber-100 mt-4">
                        <strong>Idea clave de este nivel:</strong> El n√∫mero de arriba (numerador) dice cu√°ntas partes se toman. El n√∫mero de abajo (denominador) dice
                        en cu√°ntas partes iguales se parti√≥ la unidad. Si el numerador es mayor que el denominador, la fracci√≥n
                        es <strong>mayor que 1</strong>.
                    </div>
                </div>
                ),
                miniQuiz: [
                {
                    question: "En el beneficiadero se representan las canastas de caf√© con la fracci√≥n 3/2. ¬øQu√© significa?",
                    options: [
                    "Tres canastas llenas",
                    "Tres mitades de canasta (1.5 canastas)",
                    "Media canasta",
                    "Menos de una canasta"
                    ],
                    correct: 1
                },
                {
                    question: "Escribe con n√∫meros la frase: ‚Äúdos canastas y media de caf√©‚Äù.",
                    options: ["\\(\\frac{3}{2}\\)", "\\(\\frac{5}{2}\\)", "\\(\\frac{2}{5}\\)", "\\(\\frac{1}{2}\\)"],
                    correct: 1
                },
                {
                    question: "Lectura Cr√≠tica: Seg√∫n el texto, ¬øqu√© representa el n√∫mero entero en un n√∫mero mixto?",
                    options: ["Una cantidad completa (unidad)", "Una fracci√≥n incompleta", "La mitad de algo", "El denominador"],
                    correct: 0
                },
                {
                    question: "Lectura Cr√≠tica: Basado en la explicaci√≥n te√≥rica, ¬øpor qu√© la fracci√≥n 3/2 es mayor que 1?",
                    options: ["Porque el numerador (3) es mayor que el denominador (2)", "Porque el denominador es mayor que el numerador", "Porque tiene un n√∫mero mixto asociado", "Porque las fracciones siempre son mayores que 1"],
                    correct: 0
                }
                ]
            },
            {
                id: 'level2',
                title: 'Nivel 2: Proceso y Tiempo',
                icon: <Clock className="w-5 h-5" />,
                description: 'Fracciones de tiempo en secado y fermentaci√≥n.',
                content: (
                <div className="space-y-6">
                    <img 
                        src="https://res.cloudinary.com/dgqpeth4f/image/upload/v1764989309/tiempos1_bk2tvo.jpg" 
                        alt="Ilustraci√≥n Nivel 2" 
                        className="w-full rounded-xl shadow-md mb-4"
                    />
                    <p className="text-gray-700 dark:text-gray-300">
                    En el procesamiento del caf√© el <strong>tiempo</strong> es crucial. Una hora tiene 60 minutos.
                    </p>
                    
                    <div className="grid grid-cols-3 gap-4 text-center">
                    <div className="bg-white dark:bg-gray-800 p-3 rounded shadow">
                        <div className="text-2xl font-bold text-amber-600">{'\\(\\frac{1}{2}\\)'}</div>
                        <div className="text-xs text-gray-500">de hora</div>
                        <div className="font-semibold text-gray-800 dark:text-gray-200 mt-1">30 min</div>
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-3 rounded shadow">
                        <div className="text-2xl font-bold text-amber-600">{'\\(\\frac{1}{4}\\)'}</div>
                        <div className="text-xs text-gray-500">de hora</div>
                        <div className="font-semibold text-gray-800 dark:text-gray-200 mt-1">15 min</div>
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-3 rounded shadow">
                        <div className="text-2xl font-bold text-amber-600">{'\\(\\frac{3}{4}\\)'}</div>
                        <div className="text-xs text-gray-500">de hora</div>
                        <div className="font-semibold text-gray-800 dark:text-gray-200 mt-1">45 min</div>
                    </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-5 rounded-lg border border-amber-200 dark:border-amber-800 shadow-sm mb-4 mt-4">
                        <h3 className="text-lg font-bold text-amber-800 dark:text-amber-300 mb-3">¬øPor qu√© la precisi√≥n de minutos importa?</h3>
                        <p className="text-gray-700 dark:text-gray-300 mb-3">
                            En la fermentaci√≥n, las bacterias y levaduras consumen az√∫cares y generan √°cidos. Este proceso es r√°pido.
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300 mb-4 ml-2">
                            <li><strong>10 minutos menos:</strong> El caf√© puede quedar "plano", sin acidez brillante ni complejidad.</li>
                            <li><strong>10 minutos m√°s:</strong> El caf√© puede desarrollar defectos como sabores a "vinagre", "cebolla" o "stinker" (sobre-fermentaci√≥n).</li>
                        </ul>
                        <p className="text-gray-700 dark:text-gray-300 mb-4">
                            Aqu√≠ es donde entra la matem√°tica: Cuando un protocolo de especialidad dice "extender la fermentaci√≥n <strong>{'\\(\\frac{1}{4}\\)'}</strong> de hora", no es una sugerencia vaga; es una instrucci√≥n qu√≠mica precisa.
                        </p>

                        <h4 className="font-bold text-amber-700 dark:text-amber-400 mb-2">2. Caso Pr√°ctico: Interpretando la Receta</h4>
                        <p className="text-gray-700 dark:text-gray-300 mb-2">
                            Imagina que eres el encargado del beneficio (la finca). El Head Roaster te env√≠a esta instrucci√≥n para un lote de Geisha:
                        </p>
                        <blockquote className="border-l-4 border-amber-500 pl-4 italic text-gray-600 dark:text-gray-400 mb-4">
                            "El clima est√° fr√≠o. Despu√©s de las 18 horas est√°ndar, extiende la fermentaci√≥n <strong>{'\\(\\frac{3}{4}\\)'}</strong> de hora para resaltar las notas florales."
                        </blockquote>
                        <p className="text-gray-700 dark:text-gray-300 mb-2">El estudiante debe resolver:</p>
                        <ul className="list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300 mb-4 ml-2">
                            <li><strong>Identificar la fracci√≥n:</strong> {'\\(\\frac{3}{4}\\)'} de hora.</li>
                            <li><strong>Traducir el "DE":</strong> Multiplicar.</li>
                            <li><strong>Calcular los minutos:</strong>
                                <ul className="list-none ml-5 mt-1 space-y-1">
                                    <li>{'\\(\\text{Paso A (Dividir el reloj en 4): } 60 \\div 4 = 15 \\text{ minutos.}\\)'}</li>
                                    <li>{'\\(\\text{Paso B (Tomar 3 partes): } 15 \\times 3 = 45 \\text{ minutos.}\\)'}</li>
                                </ul>
                            </li>
                        </ul>
                        <p className="font-bold text-amber-800 dark:text-amber-300 mb-4">
                            Resultado: Debes dejar el caf√© fermentando 45 minutos extra. Ni 30, ni 50.
                        </p>

                        <h4 className="font-bold text-red-600 dark:text-red-400 mb-2">3. El Error Costoso (La confusi√≥n Decimal vs. Sexagesimal)</h4>
                        <p className="text-gray-700 dark:text-gray-300 mb-2">Este es un excelente punto para ense√±ar a evitar p√©rdidas de dinero.</p>
                        <ul className="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300 ml-2">
                            <li><strong>Situaci√≥n:</strong> Un productor anota en su bit√°cora: "Tiempo extra de fermentaci√≥n: 0.5 horas".</li>
                            <li><strong>El error:</strong> El operario ve el "5" y piensa en 50 minutos.</li>
                            <li><strong>La Realidad Matem√°tica:</strong> {'\\(0.5\\)'} es la mitad ({'\\(1/2\\)'}). <br/> {'\\(1/2 \\times 60 = 30 \\text{ minutos}\\)'}.</li>
                            <li><strong>Consecuencia:</strong> Si el operario lo deja 50 minutos en lugar de 30, se pas√≥ por 20 minutos. En un proceso anaer√≥bico t√©rmico, esos 20 minutos son suficientes para arruinar un lote de alto valor.</li>
                        </ul>
                    </div>

                    <div className="bg-amber-100 dark:bg-amber-900/40 p-4 rounded-lg border-l-4 border-amber-500 text-sm text-amber-900 dark:text-amber-100 mt-4">
                        <strong>Idea clave de este nivel:</strong> Para pasar de una fracci√≥n de hora a minutos se multiplica la fracci√≥n por 60.
                        Por ejemplo: {'\\(\\frac{3}{4}\\)'} de hora = {'\\(\\frac{3}{4}\\)'} √ó 60 = 45 minutos.
                    </div>

                    <img 
                        src="https://res.cloudinary.com/dgqpeth4f/image/upload/v1764988963/tiempos_kperos.jpg" 
                        alt="Tiempos en el proceso" 
                        className="w-full rounded-xl shadow-md mt-4"
                    />
                </div>
                ),
                miniQuiz: [
                {
                    question: "Durante el secado se revisa el caf√© cada 1/2 hora. ¬øCu√°ntos minutos son?",
                    options: ["15 minutos", "30 minutos", "45 minutos", "60 minutos"],
                    correct: 1
                },
                {
                    question: "Comparaci√≥n: ¬øQu√© es m√°s tiempo, 1/2 hora o 3/4 de hora?",
                    options: ["\\(\\frac{1}{2}\\) de hora", "\\(\\frac{3}{4}\\) de hora", "Son iguales", "No se puede saber"],
                    correct: 1
                },
                {
                    question: "Lectura Cr√≠tica: Seg√∫n la 'Regla clave', ¬øqu√© operaci√≥n matem√°tica se usa para convertir fracci√≥n de hora a minutos?",
                    options: ["Multiplicar la fracci√≥n por 60", "Dividir la fracci√≥n por 60", "Sumar 60 a la fracci√≥n", "Restar 60 a la fracci√≥n"],
                    correct: 0
                },
                {
                    question: "Lectura Cr√≠tica: De acuerdo al texto, ¬øpor qu√© es importante el tiempo en el caf√©?",
                    options: ["Es crucial para el procesamiento (secado/fermentaci√≥n)", "Para saber cu√°ndo termina la jornada laboral", "Para calcular el pago de los recolectores", "El texto no menciona que sea importante"],
                    correct: 0
                }
                ]
            },
            {
                id: 'level3',
                title: 'Nivel 3: Barismo',
                icon: <Coffee className="w-5 h-5" />,
                description: 'Recetas, razones y proporciones.',
                content: (
                <div className="space-y-6">
                    <img 
                        src="https://res.cloudinary.com/dgqpeth4f/image/upload/v1764970328/nivel_3_app_fracciones.png_k1f4oi.jpg" 
                        alt="Ilustraci√≥n Nivel 3" 
                        className="w-full rounded-xl shadow-md mb-4"
                    />
                    
                    <div className="bg-amber-50 dark:bg-amber-900/20 p-6 rounded-xl border-l-4 border-amber-600">
                        <h3 className="text-xl font-bold text-amber-800 dark:text-amber-300 mb-4">¬øQu√© es un Ratio?</h3>
                        <p className="text-gray-700 dark:text-gray-300 mb-4">
                            En el caf√©, una fracci√≥n no siempre significa "partir una unidad". A menudo, usamos las fracciones para comparar dos ingredientes diferentes: la cantidad de caf√© molido frente a la cantidad de agua. A esta comparaci√≥n la llamamos <strong>Ratio</strong>.
                        </p>
                        
                        <h4 className="text-lg font-bold text-amber-800 dark:text-amber-300 mb-2">¬øC√≥mo se lee?</h4>
                        <p className="text-gray-700 dark:text-gray-300 mb-2">
                            La l√≠nea de la fracci√≥n funciona como un "versus" o una relaci√≥n.
                        </p>
                        <p className="text-gray-700 dark:text-gray-300 mb-4">
                            <strong>Ejemplo:</strong> {'\\(\\frac{20}{300}\\)'}
                        </p>
                        <ul className="list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300 mb-4">
                            <li><strong>Numerador (Arriba):</strong> {'\\(20\\text{ g}\\)'} de caf√©.</li>
                            <li><strong>Denominador (Abajo):</strong> {'\\(300\\text{ g}\\)'} de agua.</li>
                        </ul>
                        <p className="text-gray-700 dark:text-gray-300 mb-4">
                            <strong>Lectura Barista:</strong> "Por cada {'\\(20\\text{ g}\\)'} de caf√© que uso, vierto {'\\(300\\text{ g}\\)'} de agua".
                        </p>

                        <h4 className="text-lg font-bold text-amber-800 dark:text-amber-300 mb-2">¬øPor qu√© es importante?</h4>
                        <p className="text-gray-700 dark:text-gray-300 mb-2">
                            Esta fracci√≥n define qu√© tan "fuerte" o "suave" ser√° tu bebida.
                        </p>
                        <p className="text-gray-700 dark:text-gray-300 mb-4">
                            Si usamos la misma cantidad de caf√© ({'\\(20\\text{ g}\\)'}) pero cambiamos el n√∫mero de abajo (el agua), el sabor cambia completamente.
                        </p>
                        <ul className="list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300">
                            <li>{'\\(\\frac{20}{40}\\)'} {'\\(\\rightarrow\\)'} Muy intenso (como un Espresso).</li>
                            <li>{'\\(\\frac{20}{300}\\)'} {'\\(\\rightarrow\\)'} M√°s suave y arom√°tico (como un Filtrado).</li>
                        </ul>
                    </div>

                    <img 
                        src="https://res.cloudinary.com/dgqpeth4f/image/upload/v1764985371/ratio.png_wvdkyw.jpg" 
                        alt="Ilustraci√≥n Ratio Caf√©" 
                        className="w-full rounded-xl shadow-md mb-4"
                    />
                    <p className="text-gray-700 dark:text-gray-300">
                    En el laboratorio preparamos bebidas siguiendo <strong>recetas</strong>. Una fracci√≥n puede comparar dos cantidades diferentes, como caf√© y agua.
                    </p>

                    <div className="bg-amber-100 dark:bg-amber-900/40 p-4 rounded-lg border-l-4 border-amber-500 text-sm text-amber-900 dark:text-amber-100 mt-4">
                        <strong>Idea clave de este nivel:</strong> Una fracci√≥n tambi√©n puede comparar dos cantidades diferentes (caf√© y agua, tazas y kilos, etc.).
                        Si la fracci√≥n es menor que 1, el numerador es m√°s peque√±o que el denominador.
                    </div>
                </div>
                ),
                miniQuiz: [
                {
                    question: "En una receta se usan 20g de caf√© y 300g de agua. ¬øQu√© tipo de fracci√≥n es 20/300?",
                    options: ["Mayor que 1", "Menor que 1", "Igual a 1", "No es una fracci√≥n"],
                    correct: 1
                },
                {
                    question: "Un kilo de caf√© tostado se reparte en 4 bolsas iguales. ¬øQu√© fracci√≥n de kilo hay en cada bolsa?",
                    options: ["\\(\\frac{1}{2}\\)", "\\(\\frac{1}{3}\\)", "\\(\\frac{1}{4}\\)", "\\(\\frac{1}{5}\\)"],
                    correct: 2
                },
                {
                    question: "Lectura Cr√≠tica: Seg√∫n la explicaci√≥n del 'Ratio', ¬øqu√© funci√≥n cumple la l√≠nea de la fracci√≥n?",
                    options: ["Funciona como un 'versus' o relaci√≥n de comparaci√≥n", "Indica una resta", "Indica que se parti√≥ una unidad", "No tiene funci√≥n"],
                    correct: 0
                },
                {
                    question: "Lectura Cr√≠tica: Si mantenemos fija la cantidad de caf√© pero aumentamos el agua (denominador), ¬øqu√© pasa con la bebida?",
                    options: ["Se vuelve m√°s suave y arom√°tica", "Se vuelve m√°s intensa", "Se convierte en espresso", "El sabor no cambia"],
                    correct: 0
                }
                ]
            }
        ];

        const QUESTION_BANK = [
            { id: 1, q: "Si una canasta llena es 1 unidad, ¬øqu√© representa 3/2?", options: ["3 canastas", "3 mitades (1.5)", "1.5 canastas", "Media canasta"], a: 2, explanation: "3/2 es una fracci√≥n impropia. Dividimos 3 entre 2: \\(3 \\div 2 = 1.5\\). Representa 1.5 unidades (canastas)." },
            { id: 2, q: "¬øQu√© fracci√≥n es 'dos canastas y media'?", options: ["\\(\\frac{3}{2}\\)", "\\(\\frac{5}{2}\\)", "\\(\\frac{2}{5}\\)", "\\(\\frac{1}{2}\\)"], a: 1, explanation: "Dos canastas y media es \\(2\\frac{1}{2} = \\frac{2 \\times 2 + 1}{2} = \\frac{5}{2}\\)." },
            { id: 3, q: "¬øCu√°ntos minutos son 3/4 de hora?", options: ["15 min", "30 min", "45 min", "90 min"], a: 2, explanation: "\\(\\frac{3}{4} \\times 60 = 45\\) minutos. (\\(60 \\div 4 = 15\\), luego \\(15 \\times 3 = 45\\))." },
            { id: 4, q: "Grupo A revisa cada 1/2 hora, Grupo B cada 1/4. ¬øQui√©n revisa m√°s frecuente?", options: ["Grupo A", "Grupo B", "Igual", "N/A"], a: 1, explanation: "1/4 de hora (15 min) es menor tiempo que 1/2 hora (30 min). Revisar cada 15 min es m√°s frecuente." },
            { id: 5, q: "La fracci√≥n caf√©/agua \\(\\frac{20}{300}\\) es...", options: ["Mayor que 1", "Menor que 1", "Igual a 1", "No es fracci√≥n"], a: 1, explanation: "20 es menor que 300, por lo tanto la fracci√≥n es menor que 1 (propia)." },
            { id: 6, q: "1 kg de caf√© en 4 bolsas iguales. ¬øCu√°nto en cada una?", options: ["\\(\\frac{1}{2}\\)", "\\(\\frac{1}{3}\\)", "\\(\\frac{1}{4}\\)", "\\(\\frac{1}{5}\\)"], a: 2, explanation: "Dividir 1 unidad en 4 partes iguales resulta en \\(\\frac{1}{4}\\)." },
            { id: 7, q: "1 1/2 carga como fracci√≥n impropia es:", options: ["\\(\\frac{1}{2}\\)", "\\(\\frac{2}{1}\\)", "\\(\\frac{3}{2}\\)", "\\(\\frac{5}{2}\\)"], a: 2, explanation: "\\(1\\frac{1}{2} = \\frac{2 \\times 1 + 1}{2} = \\frac{3}{2}\\)." },
            { id: 8, q: "En 3/4, ¬øqu√© indica el 4?", options: ["Partes tomadas", "Partes en que se divide la unidad", "Cargas", "Minutos"], a: 1, explanation: "El denominador (n√∫mero de abajo) indica en cu√°ntas partes iguales se dividi√≥ la unidad." },
            { id: 9, q: "7/4 canastas es igual a:", options: ["1 canasta y 1/4", "1 canasta y 3/4", "2 completas", "3/4 canasta"], a: 1, explanation: "\\(7 \\div 4 = 1\\) con residuo 3. Es decir, 1 unidad completa y 3/4 de otra." },
            { id: 10, q: "Fracci√≥n impropia de 'tres canastas y un cuarto':", options: ["\\(\\frac{7}{4}\\)", "\\(\\frac{9}{4}\\)", "\\(\\frac{13}{4}\\)", "\\(\\frac{3}{4}\\)"], a: 2, explanation: "\\(3\\frac{1}{4} = \\frac{4 \\times 3 + 1}{4} = \\frac{13}{4}\\)." },
            { id: 11, q: "¬øCu√°l es mayor: \\(\\frac{5}{4}\\) o \\(\\frac{3}{2}\\)?", options: ["\\(\\frac{5}{4}\\) (1.25)", "\\(\\frac{3}{2}\\) (1.5)", "Iguales", "\\(\\frac{1}{4}\\)"], a: 1, explanation: "\\(5/4 = 1.25\\), \\(3/2 = 1.5\\). 1.5 es mayor que 1.25." },
            { id: 12, q: "Fermentaci√≥n dura 1 1/2 horas. ¬øMinutos totales?", options: ["45", "60", "75", "90"], a: 3, explanation: "1.5 horas = \\(1.5 \\times 60 = 90\\) minutos." },
            { id: 13, q: "¬øCu√°ntos minutos son 1/3 de hora?", options: ["10", "15", "20", "30"], a: 2, explanation: "\\(60 \\div 3 = 20\\) minutos." },
            { id: 14, q: "¬øQu√© es m√°s largo: 2/3 de hora o 3/5 de hora?", options: ["2/3 (40m)", "3/5 (36m)", "Iguales", "N/A"], a: 0, explanation: "\\(2/3 \\times 60 = 40\\) min. \\(3/5 \\times 60 = 36\\) min. 40 es mayor." },
            { id: 15, q: "Receta A: 18/270. Receta B: 22/330. ¬øComparaci√≥n?", options: ["A m√°s concentrada", "B m√°s concentrada", "Misma proporci√≥n (1/15)", "N/A"], a: 2, explanation: "Simplificando: \\(18/270 = 1/15\\). \\(22/330 = 1/15\\). Son equivalentes." },
            { id: 16, q: "¬øCu√°l es m√°s concentrada?", options: ["18g/300g", "25g/300g", "15g/300g", "10g/300g"], a: 1, explanation: "A igual cantidad de agua (300g), la que tenga m√°s caf√© (25g) es m√°s concentrada." },
            { id: 17, q: "3 bolsas de 1/4 kg. ¬øTotal?", options: ["\\(\\frac{1}{2}\\) kg", "\\(\\frac{3}{4}\\) kg", "1 kg", "\\(\\frac{4}{3}\\) kg"], a: 1, explanation: "\\(3 \\times \\frac{1}{4} = \\frac{3}{4}\\) kg." },
            { id: 18, q: "1 kg en 5 bolsas. ¬øCada una?", options: ["\\(\\frac{1}{2}\\)", "\\(\\frac{1}{3}\\)", "\\(\\frac{1}{4}\\)", "\\(\\frac{1}{5}\\)"], a: 3, explanation: "1 dividido 5 es \\(1/5\\)." },
            { id: 19, q: "Bolsa pesa 1/2 kg. ¬øCu√°ntas para 2 kg?", options: ["2", "3", "4", "5"], a: 2, explanation: "\\(2 \\div 0.5 = 4\\) bolsas (o \\(2 \\div \\frac{1}{2} = 4\\))." },
            { id: 20, q: "2 1/4 cargas a fracci√≥n impropia:", options: ["\\(\\frac{5}{4}\\)", "\\(\\frac{7}{4}\\)", "\\(\\frac{9}{4}\\)", "\\(\\frac{11}{4}\\)"], a: 2, explanation: "\\(2\\frac{1}{4} = \\frac{4 \\times 2 + 1}{4} = \\frac{9}{4}\\)." },
            { id: 21, q: "Equivalente a 1/2:", options: ["\\(\\frac{1}{4}\\)", "\\(\\frac{2}{6}\\)", "\\(\\frac{2}{4}\\)", "\\(\\frac{3}{8}\\)"], a: 2, explanation: "\\(2/4\\) simplificado (dividiendo ambos por 2) es \\(1/2\\)." },
            { id: 22, q: "Ordena 1/4, 1/2, 3/4. ¬øLa del medio?", options: ["\\(\\frac{1}{4}\\)", "\\(\\frac{1}{2}\\)", "\\(\\frac{3}{4}\\)", "Iguales"], a: 1, explanation: "0.25, 0.5, 0.75. La del medio es 0.5 (1/2)." },
            { id: 23, q: "20 tazas, se sirven 10. ¬øFracci√≥n?", options: ["\\(\\frac{1}{4}\\)", "\\(\\frac{1}{2}\\)", "\\(\\frac{3}{4}\\)", "\\(\\frac{2}{3}\\)"], a: 1, explanation: "\\(10/20 = 1/2\\)." },
            { id: 24, q: "En 5/6, ¬øqu√© es el 5?", options: ["Partes tomadas", "Divisiones unidad", "Total", "Tazas"], a: 0, explanation: "El numerador (n√∫mero de abajo) indica las partes que se toman o seleccionan." },
            { id: 25, q: "1/3 es Finca A. ¬øEl resto (Finca B)?", options: ["\\(\\frac{1}{3}\\)", "\\(\\frac{2}{3}\\)", "\\(\\frac{3}{3}\\)", "\\(\\frac{1}{2}\\)"], a: 1, explanation: "La unidad completa es 3/3. \\(3/3 - 1/3 = 2/3\\)." },
            { id: 26, q: "¬øCu√°l es mayor: 1/5 o 1/4?", options: ["\\(\\frac{1}{5}\\)", "\\(\\frac{1}{4}\\)", "Iguales", "N/A"], a: 1, explanation: "\\(1/4 = 0.25\\), \\(1/5 = 0.20\\). 1/4 es mayor." },
            { id: 27, q: "2/4 simplificado:", options: ["\\(\\frac{1}{4}\\)", "\\(\\frac{1}{2}\\)", "\\(\\frac{2}{4}\\)", "\\(\\frac{3}{4}\\)"], a: 1, explanation: "Mitad de 2 es 1, mitad de 4 es 2. Resultado \\(1/2\\)." },
            { id: 28, q: "3/4 a decimal:", options: ["0.25", "0.33", "0.50", "0.75"], a: 3, explanation: "\\(3 \\div 4 = 0.75\\)." },
        ];

        // --- COMPONENTS ---

        const CelebrationOverlay = ({ show, onNext, nextTitle }) => {
            if (!show) return null;
            return (
                <div className="celebration-overlay animate-in fade-in">
                    <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 text-center transform animate-in zoom-in border-4 border-amber-500 relative overflow-hidden">
                        {/* Confetti simulation elements */}
                        <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                            <div className="absolute top-4 left-4 text-2xl animate-bounce-slow">üéâ</div>
                            <div className="absolute top-4 right-4 text-2xl animate-bounce-slow" style={{animationDelay: '0.5s'}}>‚ú®</div>
                            <div className="absolute bottom-10 left-10 text-2xl animate-bounce-slow" style={{animationDelay: '1s'}}>‚òï</div>
                            <div className="absolute bottom-10 right-10 text-2xl animate-bounce-slow" style={{animationDelay: '1.5s'}}>‚≠ê</div>
                        </div>

                        <div className="w-20 h-20 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Award className="w-10 h-10 text-green-600 dark:text-green-400" />
                        </div>
                        <h2 className="text-2xl font-bold text-amber-900 dark:text-amber-100 mb-2">¬°Excelente Trabajo!</h2>
                        <p className="text-gray-600 dark:text-gray-300 mb-6">
                            Has dominado este tema. ¬°Sigue as√≠, el campo te espera!
                        </p>
                        <button 
                            onClick={onNext}
                            className="w-full py-3 bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 transform transition hover:scale-105"
                        >
                            Continuar a {nextTitle} <ArrowRight size={20} />
                        </button>
                    </div>
                </div>
            );
        };

        const Header = ({ darkMode, toggleTheme, user, onOpenMenu }) => (
            <header className="sticky top-0 z-50 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md shadow-sm border-b border-amber-100 dark:border-amber-900 transition-colors duration-300">
            <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                <div className="flex items-center gap-2">
                <button onClick={onOpenMenu} className="lg:hidden p-2 text-amber-800 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-gray-800 rounded-full transition-colors">
                    <Menu size={24} />
                </button>
                <div className="bg-amber-600 p-1.5 rounded-lg">
                    <Coffee className="text-white w-6 h-6" />
                </div>
                <h1 className="font-bold text-xl text-amber-900 dark:text-amber-100 hidden sm:block">
                    Caf√© San Juan <span className="font-light text-amber-700 dark:text-amber-400">| Matem√°ticas</span>
                </h1>
                </div>

                <div className="flex items-center gap-4">
                {user && (
                    <div className="hidden md:flex flex-col items-end text-xs text-gray-500 dark:text-gray-400">
                    <span className="font-semibold text-amber-800 dark:text-amber-300">{user.name}</span>
                    <span>{user.role}</span>
                    </div>
                )}
                <button 
                    onClick={toggleTheme}
                    className="p-2 rounded-full hover:bg-amber-50 dark:hover:bg-gray-800 text-amber-800 dark:text-amber-300 transition-all duration-300"
                    title={darkMode ? "Modo Claro" : "Modo Oscuro"}
                >
                    {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                </div>
            </div>
            </header>
        );

        const Sidebar = ({ isOpen, onClose, currentSection, setSection, progress, resetData }) => {
            const menuItems = [
            { id: 'welcome', label: 'Inicio', icon: Home },
            { id: 'level0', label: 'Nivel 0: Conceptual', icon: BookOpen },
            { id: 'level1', label: 'Nivel 1: Recolecci√≥n', icon: Leaf },
            { id: 'level2', label: 'Nivel 2: Proceso', icon: Clock },
            { id: 'level3', label: 'Nivel 3: Barismo', icon: Coffee },
            { id: 'glossary', label: 'Glosario', icon: BookOpen },
            { id: 'test', label: 'Test Final', icon: Award },
            ];

            return (
            <>
                {/* Overlay */}
                <div 
                className={`fixed inset-0 bg-black/50 z-40 transition-opacity duration-300 lg:hidden ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                onClick={onClose}
                />
                
                {/* Sidebar Panel */}
                <aside className={`fixed top-0 left-0 h-full w-72 bg-white dark:bg-gray-900 border-r border-amber-100 dark:border-amber-900 z-50 transform transition-transform duration-300 lg:translate-x-0 lg:static lg:h-[calc(100vh-4rem)] lg:z-0 shadow-xl lg:shadow-none ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                <div className="p-4 flex justify-between items-center lg:hidden border-b border-gray-100 dark:border-gray-800">
                    <span className="font-bold text-amber-900 dark:text-amber-100">Men√∫</span>
                    <button onClick={onClose} className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">
                    <X size={20} />
                    </button>
                </div>

                <div className="p-4 space-y-1 overflow-y-auto h-full pb-20">
                    <div className="mb-6 px-2">
                    <h2 className="text-xs uppercase tracking-wider text-gray-400 font-semibold mb-2">Ruta de aprendizaje</h2>
                    <div className="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full overflow-hidden">
                        <div 
                        className="bg-amber-500 h-full transition-all duration-500 ease-out"
                        style={{ width: `${(Object.values(progress).filter(Boolean).length / 4) * 100}%` }}
                        />
                    </div>
                    <p className="text-xs text-right mt-1 text-amber-600 dark:text-amber-400 font-medium">
                        {Math.round((Object.values(progress).filter(Boolean).length / 4) * 100)}% Completado
                    </p>
                    </div>

                    {menuItems.map((item) => {
                    const Icon = item.icon;
                    const isCompleted = progress[item.id];
                    const isActive = currentSection === item.id;
                    
                    return (
                        <button
                        key={item.id}
                        onClick={() => { setSection(item.id); onClose(); }}
                        className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition-all duration-200 
                            ${isActive 
                            ? 'bg-amber-100 text-amber-900 dark:bg-amber-900/40 dark:text-amber-100 shadow-sm' 
                            : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-amber-700 dark:hover:text-amber-200'
                            }`}
                        >
                        <div className={`p-1 rounded ${isCompleted ? 'text-green-500' : ''}`}>
                            {isCompleted ? <CheckCircle size={16} /> : <Icon size={18} />}
                        </div>
                        <span>{item.label}</span>
                        {isActive && <ChevronRight size={16} className="ml-auto text-amber-500" />}
                        </button>
                    );
                    })}

                    <div className="mt-8 pt-4 border-t border-gray-100 dark:border-gray-800">
                    <button 
                        onClick={resetData}
                        className="w-full flex items-center gap-3 px-3 py-2 text-xs text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors"
                    >
                        <RefreshCw size={14} />
                        Borrar datos y reiniciar
                    </button>
                    </div>
                </div>
                </aside>
            </>
            );
        };

        const WelcomeScreen = ({ userData, setUserData, onStart }) => {
            const [formData, setFormData] = useState(userData || { name: '', role: 'Estudiante', group: '' });

            const handleSubmit = (e) => {
            e.preventDefault();
            setUserData(formData);
            onStart();
            };

            return (
            <div className="max-w-2xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-700">
                <div className="text-center mb-10">
                <div className="mb-6">
                    <img 
                        src="https://res.cloudinary.com/dgqpeth4f/image/upload/v1748483304/logo_aaa_hvqghu.png" 
                        alt="Logo Caf√© San Juan" 
                        className="w-32 h-32 mx-auto object-contain drop-shadow-md hover:scale-105 transition-transform duration-300" 
                    />
                </div>
                <h2 className="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
                    Fracciones con Caf√© San Juan
                </h2>
                <p className="text-lg text-gray-600 dark:text-gray-300 max-w-lg mx-auto">
                    Descubre c√≥mo las matem√°ticas son esenciales en la recolecci√≥n, proceso y preparaci√≥n del mejor caf√©.
                </p>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 md:p-8 border border-amber-100 dark:border-amber-900">
                <h3 className="text-xl font-semibold mb-6 flex items-center gap-2 text-amber-800 dark:text-amber-300">
                    <User className="w-5 h-5" />
                    Tus Datos
                </h3>
                <form onSubmit={handleSubmit} className="space-y-5">
                    <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre Completo</label>
                    <input 
                        required
                        type="text" 
                        className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none transition-all"
                        placeholder="Ej. Alejandro Mart√≠nez"
                        value={formData.name}
                        onChange={e => setFormData({...formData, name: e.target.value})}
                    />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rol</label>
                        <select 
                        className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none"
                        value={formData.role}
                        onChange={e => setFormData({...formData, role: e.target.value})}
                        >
                        <option>Estudiante</option>
                        <option>Docente</option>
                        <option>Caficultor</option>
                        <option>Visitante</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grado / Grupo</label>
                        <input 
                        type="text" 
                        className="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none"
                        placeholder="Ej. 6-A"
                        value={formData.group}
                        onChange={e => setFormData({...formData, group: e.target.value})}
                        />
                    </div>
                    </div>
                    <button 
                    type="submit"
                    className="w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:-translate-y-0.5"
                    >
                    Comenzar Aventura Cafetera
                    </button>
                </form>
                </div>
            </div>
            );
        };

        const MiniQuiz = ({ questions, onComplete }) => {
            const [current, setCurrent] = useState(0);
            const [feedback, setFeedback] = useState(null); // 'correct' | 'incorrect'
            const [completed, setCompleted] = useState(false);

            // Re-render MathJax on state changes within MiniQuiz
            useEffect(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise();
                }
            }, [current, feedback]);

            // Create shuffled options for the current question
            const shuffledOptions = useMemo(() => {
                const q = questions[current];
                // Map to keep track of original indices
                const optionsWithIndex = q.options.map((opt, idx) => ({ text: opt, originalIndex: idx }));
                // Shuffle
                return optionsWithIndex.sort(() => Math.random() - 0.5);
            }, [current, questions]); // Re-shuffle only when question changes

            const handleAnswer = (originalIndex) => {
                if (originalIndex === questions[current].correct) {
                    setFeedback('correct');
                    setTimeout(() => {
                    setFeedback(null);
                    if (current < questions.length - 1) {
                        setCurrent(c => c + 1);
                    } else {
                        setCompleted(true);
                        onComplete();
                    }
                    }, 1000);
                } else {
                    setFeedback('incorrect');
                    setTimeout(() => setFeedback(null), 800);
                }
            };

            if (completed) {
            return (
                <div className="mt-8 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-6 text-center animate-in zoom-in duration-300">
                <div className="inline-block p-3 bg-green-100 dark:bg-green-800 rounded-full mb-3">
                    <CheckCircle className="w-8 h-8 text-green-600 dark:text-green-300" />
                </div>
                <h4 className="font-bold text-green-800 dark:text-green-300">¬°Reto Completado!</h4>
                <p className="text-sm text-green-700 dark:text-green-400">¬°Muy bien hecho! Puedes avanzar.</p>
                </div>
            );
            }

            const q = questions[current];

            return (
            <div className="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div className="bg-amber-50 dark:bg-gray-700 p-4 border-b border-amber-100 dark:border-gray-600 flex justify-between items-center">
                <span className="text-xs font-bold uppercase tracking-wider text-amber-700 dark:text-amber-400">
                    Mini-Reto {current + 1} de {questions.length}
                </span>
                <div className="flex gap-1">
                    {questions.map((_, i) => (
                    <div key={i} className={`w-2 h-2 rounded-full ${i === current ? 'bg-amber-500' : 'bg-gray-300 dark:bg-gray-600'}`} />
                    ))}
                </div>
                </div>
                <div className={`p-6 ${feedback === 'incorrect' ? 'animate-shake' : ''}`}>
                <h4 key={q.question} className="font-semibold text-lg text-gray-900 dark:text-white mb-6">{q.question}</h4>
                <div className="space-y-3">
                    {shuffledOptions.map((optObj, i) => (
                    <button
                        key={`${q.question}-${i}`}
                        onClick={() => handleAnswer(optObj.originalIndex)}
                        className={`w-full text-left p-4 rounded-lg border-2 transition-all duration-200 flex justify-between items-center
                        ${feedback === 'correct' && optObj.originalIndex === q.correct 
                            ? 'border-green-500 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300' 
                            : feedback === 'incorrect' && optObj.originalIndex !== q.correct 
                            ? 'border-red-200 dark:border-red-800 opacity-50'
                            : 'border-gray-100 dark:border-gray-700 hover:border-amber-400 hover:bg-amber-50 dark:hover:bg-gray-700 dark:text-gray-200'
                        }
                        `}
                    >
                        <span key={optObj.text}>{optObj.text}</span>
                        {feedback === 'correct' && optObj.originalIndex === q.correct && <CheckCircle className="w-5 h-5 text-green-500" />}
                    </button>
                    ))}
                </div>
                </div>
            </div>
            );
        };

        const LevelView = ({ levelData, onLevelComplete }) => {
            return (
            <div className="max-w-3xl mx-auto animate-in fade-in duration-500">
                <div className="mb-6 flex items-center gap-3">
                <div className="p-3 bg-amber-100 dark:bg-amber-900/40 rounded-xl text-amber-700 dark:text-amber-400">
                    {levelData.icon}
                </div>
                <div>
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white">{levelData.title}</h2>
                    <p className="text-gray-500 dark:text-gray-400">{levelData.description}</p>
                </div>
                </div>

                <div key={levelData.id + '-content'} className="prose dark:prose-invert max-w-none mb-10 text-gray-700 dark:text-gray-300">
                {levelData.content}
                </div>

                {/* Important: Key prop added to reset state when level changes */}
                {levelData.miniQuiz ? (
                <MiniQuiz key={levelData.id} questions={levelData.miniQuiz} onComplete={onLevelComplete} />
                ) : (
                <button 
                    onClick={onLevelComplete}
                    className="w-full py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md font-bold transition-colors flex items-center justify-center gap-2"
                >
                    <CheckCircle />
                    Marcar como Le√≠do y Completado
                </button>
                )}
            </div>
            );
        };

        const GlossaryView = () => (
            <div className="max-w-3xl mx-auto animate-in fade-in">
            <h2 className="text-2xl font-bold text-amber-900 dark:text-amber-100 mb-6 flex items-center gap-2">
                <BookOpen className="text-amber-600" /> Glosario Cafetero
            </h2>
            <div className="grid gap-4">
                {GLOSSARY.map((item, i) => (
                <div key={i} className="bg-white dark:bg-gray-800 p-5 rounded-xl border-l-4 border-amber-500 shadow-sm hover:shadow-md transition-shadow">
                    <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-1">{item.term}</h3>
                    <p className="text-gray-600 dark:text-gray-300">{item.def}</p>
                </div>
                ))}
            </div>
            </div>
        );

        const TestView = ({ user, onFinish }) => {
            const questions = useMemo(() => {
                // Shuffle questions
                const shuffledQs = [...QUESTION_BANK].sort(() => 0.5 - Math.random()).slice(0, 10);
                
                // Also shuffle options for each selected question
                return shuffledQs.map(q => {
                    const shuffledOpts = q.options.map((opt, idx) => ({ text: opt, originalIndex: idx }))
                                                  .sort(() => Math.random() - 0.5);
                    return { ...q, shuffledOptions: shuffledOpts };
                });
            }, []);

            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({}); 
            const [timer, setTimer] = useState(0);
            const [isFinished, setIsFinished] = useState(false);
            const [isSending, setIsSending] = useState(false);

            useEffect(() => {
            if (isFinished) return;
            const interval = setInterval(() => setTimer(t => t + 1), 1000);
            return () => clearInterval(interval);
            }, [isFinished]);

            // Re-render MathJax on state changes within TestView
            useEffect(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise();
                }
            }, [currentIdx, isFinished]);

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            const handleSelect = (qId, originalOptionIdx) => {
                setAnswers(prev => ({ ...prev, [qId]: originalOptionIdx }));
            };

            const sendToGoogleForm = async (score, time) => {
                if (!GOOGLE_FORM_CONFIG.enabled) {
                    console.log("Env√≠o a Forms deshabilitado. Configura los IDs en el c√≥digo.");
                    return;
                }

                setIsSending(true);
                const formData = new FormData();
                if(GOOGLE_FORM_CONFIG.fields.name) formData.append(GOOGLE_FORM_CONFIG.fields.name, user.name);
                if(GOOGLE_FORM_CONFIG.fields.role) formData.append(GOOGLE_FORM_CONFIG.fields.role, user.role);
                if(GOOGLE_FORM_CONFIG.fields.group) formData.append(GOOGLE_FORM_CONFIG.fields.group, user.group);
                if(GOOGLE_FORM_CONFIG.fields.score) formData.append(GOOGLE_FORM_CONFIG.fields.score, score + "/10");
                if(GOOGLE_FORM_CONFIG.fields.time) formData.append(GOOGLE_FORM_CONFIG.fields.time, formatTime(time));

                try {
                    await fetch(GOOGLE_FORM_CONFIG.formUrl, {
                        method: "POST",
                        mode: "no-cors",
                        body: formData
                    });
                    console.log("Datos enviados a Google Form");
                } catch (e) {
                    console.error("Error al enviar", e);
                } finally {
                    setIsSending(false);
                }
            };

            const handleSubmit = async () => {
                let score = 0;
                questions.forEach(q => {
                    if (answers[q.id] === q.a) score++;
                });

                // Send data BEFORE showing results screen
                await sendToGoogleForm(score, timer);
                
                setIsFinished(true);
                onFinish({ score, total: 10, time: timer, details: { questions, answers } });
            };

            if (isFinished) {
            const score = Object.keys(answers).reduce((acc, qId) => {
                const q = questions.find(qu => qu.id === parseInt(qId));
                return acc + (q && answers[qId] === q.a ? 1 : 0);
            }, 0);

            return (
                <div className="max-w-3xl mx-auto animate-in zoom-in duration-500">
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden mb-8">
                    <div className="bg-gradient-to-r from-amber-600 to-amber-800 p-8 text-white text-center">
                    <h2 className="text-3xl font-bold mb-2">¬°Test Finalizado!</h2>
                    {GOOGLE_FORM_CONFIG.enabled && <p className="text-sm bg-white/20 inline-block px-3 py-1 rounded-full mt-2">‚úÖ Resultados enviados</p>}
                    <div className="flex justify-center gap-8 mt-6">
                        <div className="text-center">
                        <div className="text-4xl font-bold">{score}/10</div>
                        <div className="text-amber-100 text-sm">Puntaje</div>
                        </div>
                        <div className="text-center border-l border-amber-500 pl-8">
                        <div className="text-4xl font-bold">{formatTime(timer)}</div>
                        <div className="text-amber-100 text-sm">Tiempo</div>
                        </div>
                    </div>
                    </div>
                    <div className="p-8">
                    <h3 className="font-bold text-gray-800 dark:text-gray-200 mb-4">Revisi√≥n de Respuestas</h3>
                    <div className="space-y-6">
                        {questions.map((q, i) => {
                        const userAns = answers[q.id];
                        const isCorrect = userAns === q.a;
                        return (
                            <div key={q.id} className={`p-4 rounded-lg border ${isCorrect ? 'border-green-200 bg-green-50 dark:bg-green-900/20 dark:border-green-800' : 'border-red-200 bg-red-50 dark:bg-red-900/20 dark:border-red-800'}`}>
                            <p className="font-medium text-gray-800 dark:text-gray-200 mb-2">
                                <span className="font-bold mr-2">{i + 1}.</span>{q.q}
                            </p>
                            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center text-sm gap-2">
                                <span className={isCorrect ? 'text-green-700 dark:text-green-400 font-bold' : 'text-red-600 dark:text-red-400'}>
                                Tu respuesta: {userAns !== undefined ? q.options[userAns] : 'Sin responder'}
                                </span>
                                {!isCorrect && (
                                <span className="text-gray-500 dark:text-gray-400">
                                    Correcta: <span className="font-bold text-green-600 dark:text-green-400">{q.options[q.a]}</span>
                                </span>
                                )}
                            </div>
                            {q.explanation && (
                                <div className="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-100 dark:border-blue-800 text-sm">
                                    <span className="font-bold text-blue-800 dark:text-blue-300 block mb-1">Por qu√©:</span>
                                    <span className="text-gray-700 dark:text-gray-300">{q.explanation}</span>
                                </div>
                            )}
                            </div>
                        );
                        })}
                    </div>
                    <button 
                        onClick={() => window.location.reload()} 
                        className="mt-8 w-full py-3 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg shadow transition-colors"
                    >
                        Intentar de nuevo (Nuevas preguntas)
                    </button>
                    </div>
                </div>
                </div>
            );
            }

            const q = questions[currentIdx];

            return (
            <div className="max-w-2xl mx-auto h-[calc(100vh-140px)] flex flex-col">
                <div className="flex justify-between items-center mb-6 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div>
                    <span className="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-bold">Pregunta</span>
                    <div className="text-2xl font-bold text-amber-600">{currentIdx + 1}<span className="text-lg text-gray-400">/10</span></div>
                </div>
                <div className="text-right">
                    <span className="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider font-bold flex items-center justify-end gap-1">
                    <Clock size={12} /> Tiempo
                    </span>
                    <div className="text-xl font-mono text-gray-700 dark:text-gray-200">{formatTime(timer)}</div>
                </div>
                </div>

                <div className="flex-1 overflow-y-auto">
                <div className="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg border border-amber-100 dark:border-gray-700">
                    <h3 key={q.id} className="text-xl font-medium text-gray-900 dark:text-white mb-8 leading-relaxed">
                    {q.q}
                    </h3>
                    
                    <div className="space-y-3">
                    {q.shuffledOptions.map((optObj, i) => (
                        <button
                        key={`${q.id}-${i}`}
                        onClick={() => handleSelect(q.id, optObj.originalIndex)}
                        className={`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center justify-between group
                            ${answers[q.id] === optObj.originalIndex 
                            ? 'border-amber-500 bg-amber-50 dark:bg-amber-900/30 text-amber-900 dark:text-amber-100 font-medium' 
                            : 'border-gray-100 dark:border-gray-700 hover:border-amber-300 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-300'
                            }`}
                        >
                        <span key={optObj.text}>{optObj.text}</span>
                        <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center
                            ${answers[q.id] === optObj.originalIndex ? 'border-amber-500' : 'border-gray-300 dark:border-gray-500'}`}>
                            {answers[q.id] === optObj.originalIndex && <div className="w-2.5 h-2.5 rounded-full bg-amber-500" />}
                        </div>
                        </button>
                    ))}
                    </div>
                </div>
                </div>

                <div className="mt-6 flex justify-between gap-4">
                <button
                    onClick={() => setCurrentIdx(Math.max(0, currentIdx - 1))}
                    disabled={currentIdx === 0}
                    className="px-6 py-3 rounded-lg font-medium text-gray-600 dark:text-gray-400 disabled:opacity-30 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                >
                    Anterior
                </button>

                {currentIdx === questions.length - 1 ? (
                    <button
                    onClick={handleSubmit}
                    disabled={Object.keys(answers).length < 10 || isSending}
                    className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 dark:disabled:bg-gray-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2"
                    >
                    {isSending ? 'Enviando...' : (
                        <>
                            Terminar Test y Enviar Resultados <Send size={20} />
                        </>
                    )}
                    </button>
                ) : (
                    <button
                    onClick={() => setCurrentIdx(Math.min(9, currentIdx + 1))}
                    className="px-8 py-3 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg shadow-md transition-colors flex items-center gap-2"
                    >
                    Siguiente <ChevronRight size={18} />
                    </button>
                )}
                </div>
            </div>
            );
        };

        // --- MAIN APP COMPONENT ---

        const NEXT_LEVEL_MAP = {
            'level0': 'level1',
            'level1': 'level2',
            'level2': 'level3',
            'level3': 'test',
            'test': 'welcome'
        };

        const LEVEL_TITLES = {
            'level1': 'Nivel 1: Recolecci√≥n',
            'level2': 'Nivel 2: Proceso',
            'level3': 'Nivel 3: Barismo',
            'test': 'Test Final',
            'welcome': 'Inicio'
        };

        function CafeMathApp() {
            const [darkMode, setDarkMode] = useState(false);
            const [userData, setUserData] = useState(null);
            const [section, setSection] = useState('welcome');
            const [progress, setProgress] = useState({
                level0: false, level1: false, level2: false, level3: false, test: false
            });
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showCelebration, setShowCelebration] = useState(false);
            const [pendingNextSection, setPendingNextSection] = useState(null);

            // Load persistence
            useEffect(() => {
            const savedUser = localStorage.getItem('cafeMath_user');
            const savedProgress = localStorage.getItem('cafeMath_progress');
            const savedTheme = localStorage.getItem('cafeMath_theme');

            if (savedUser) {
                setUserData(JSON.parse(savedUser));
                setSection('level0'); // Skip welcome if user exists
            }
            if (savedProgress) setProgress(JSON.parse(savedProgress));
            if (savedTheme === 'dark') setDarkMode(true);
            }, []);

            // Save persistence
            useEffect(() => {
            if (userData) localStorage.setItem('cafeMath_user', JSON.stringify(userData));
            }, [userData]);

            useEffect(() => {
            localStorage.setItem('cafeMath_progress', JSON.stringify(progress));
            }, [progress]);

            useEffect(() => {
            localStorage.setItem('cafeMath_theme', darkMode ? 'dark' : 'light');
            if (darkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            // Re-render MathJax on state changes
            useEffect(() => {
                if (window.MathJax) {
                    window.MathJax.typesetPromise && window.MathJax.typesetPromise();
                }
            });

            const handleLevelComplete = (levelId) => {
                setProgress(prev => ({ ...prev, [levelId]: true }));
                
                // Determine next level
                const next = NEXT_LEVEL_MAP[levelId];
                if (next && levelId !== 'test') { // Don't show celebration for Test, it has its own result screen
                    setPendingNextSection(next);
                    setShowCelebration(true);
                }
            };

            const advanceToNextLevel = () => {
                setShowCelebration(false);
                if (pendingNextSection) {
                    setSection(pendingNextSection);
                    setPendingNextSection(null);
                }
            };

            const handleReset = () => {
            if(confirm("¬øEst√°s seguro de borrar todo tu progreso?")) {
                localStorage.clear();
                window.location.reload();
            }
            };

            const renderContent = () => {
            switch (section) {
                case 'welcome':
                return <WelcomeScreen userData={userData} setUserData={setUserData} onStart={() => setSection('level0')} />;
                case 'level0':
                return <LevelView levelData={LEVELS_DATA[0]} onLevelComplete={() => handleLevelComplete('level0')} />;
                case 'level1':
                return <LevelView levelData={LEVELS_DATA[1]} onLevelComplete={() => handleLevelComplete('level1')} />;
                case 'level2':
                return <LevelView levelData={LEVELS_DATA[2]} onLevelComplete={() => handleLevelComplete('level2')} />;
                case 'level3':
                return <LevelView levelData={LEVELS_DATA[3]} onLevelComplete={() => handleLevelComplete('level3')} />;
                case 'glossary':
                return <GlossaryView />;
                case 'test':
                return <TestView user={userData} onFinish={(res) => handleLevelComplete('test')} />;
                default:
                return <WelcomeScreen onStart={() => setSection('level0')} />;
            }
            };

            return (
            <div className={`min-h-screen transition-colors duration-300 ${darkMode ? 'dark bg-gray-900' : 'bg-[#F9F5F0]'}`}>
                <div className="flex flex-col min-h-screen text-gray-900 dark:text-gray-100 font-sans">
                
                <CelebrationOverlay 
                    show={showCelebration} 
                    onNext={advanceToNextLevel}
                    nextTitle={pendingNextSection ? LEVEL_TITLES[pendingNextSection] : 'Siguiente Nivel'} 
                />

                <Header 
                    darkMode={darkMode} 
                    toggleTheme={() => setDarkMode(!darkMode)} 
                    user={userData}
                    onOpenMenu={() => setIsMenuOpen(true)}
                />

                <div className="flex flex-1 max-w-7xl mx-auto w-full">
                    {/* Desktop Sidebar: Visible only on large screens */}
                    {userData && (
                    <div className="hidden lg:block w-72 flex-shrink-0 pt-6">
                        <Sidebar 
                        isOpen={true}
                        onClose={() => {}} 
                        currentSection={section}
                        setSection={setSection}
                        progress={progress}
                        resetData={handleReset}
                        />
                    </div>
                    )}

                    {/* Mobile Sidebar: Hidden on large screens to prevent duplication */}
                    <div className="lg:hidden">
                        <Sidebar 
                            isOpen={isMenuOpen} 
                            onClose={() => setIsMenuOpen(false)} 
                            currentSection={section}
                            setSection={setSection}
                            progress={progress}
                            resetData={handleReset}
                        />
                    </div>

                    <main className="flex-1 p-4 md:p-8 overflow-x-hidden">
                    {renderContent()}
                    </main>
                </div>
                </div>
            </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CafeMathApp />);
    </script>
</body>
</html>
